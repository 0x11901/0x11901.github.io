[{"title":"如何使用Logos优雅的注入Mac app","url":"/2018/02/10/如何使用Logos优雅的注入Mac-app/","content":"\n## 前言\nLogos是[Theos](https://github.com/theos/theos)的一个组件，它允许程序员使用一组特殊的预处理器指令来编写钩子，简洁高效。\n做过iOS逆向开发的朋友应该非常熟悉，这里笔者将介绍如何在Mac app上使用Logos。\n\n## 可能用到的工具\n1. [Theos](https://github.com/theos/theos)\n2. [optool](https://github.com/alexzielenski/optool)/[insert_dylib](https://github.com/Tyilo/insert_dylib)\n3. [unsign](https://github.com/steakknife/unsign) (optional)\n\n## 一个简单的例子\n* 编写一个简单的demo，大概就是\b\b软件正中一个按钮，点击之后alert(\"hi!\")\b。核心代码如下：\n\n    ```objc\n    #import \"ViewController.h\"\n    \n    @implementation ViewController\n    \n    - (void)viewDidLoad {\n        [super viewDidLoad];\n    \n        // Do any additional setup after loading the view.\n    }\n    \n    - (IBAction)sayHi:(NSButton *)sender {\n        NSAlert *alert = NSAlert.new;\n        alert.messageText = @\"hi!\";\n        alert.alertStyle = NSAlertStyleInformational;\n        [alert runModal];\n    }\n    \n    \n    - (void)setRepresentedObject:(id)representedObject {\n        [super setRepresentedObject:representedObject];\n    \n        // Update the view, if already loaded.\n    }\n    \n    \n    @end\n    ```\n    ![效果图](http://ooph3gs8p.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-10%2021.53.36.png)\n\n我们的目标是注入sayHi这个方法，使点击按钮之后不再说“hi!”，而是“hello world!”\n* 编写Logos\n\n    ```objc\n    %config(generator=internal)  // ★★加上这句★★\n    \n    // You don't need to #include <substrate.h>, it will be done automatically, as will\n    // the generation of a class list and an automatic constructor.\n    #import <Foundation/Foundation.h>\n    \n    %hook ViewController\n    \n    \n    // Hooking an instance method with an argument.\n    - (void)sayHi:(id)argument {\n        NSAlert *r15 = [[NSAlert alloc] init];\n        [r15 setMessageText:@\"hello world!\"];\n        [r15 setAlertStyle:0x1];\n        [r15 runModal];\n    }\n    \n    \n    \n    // Always make sure you clean up after yourself; Not doing so could have grave consequences!\n    %end\n    \n    %ctor {\n        NSLog(@\"!!!!!!inject success!!!!!!!\");\n    }\n    ```\n    将以上代码保存为一个Tweak.xm文件(名字后缀名随意)，放在与SayHi.app同级目录下，便于后续操作。\n\n* 然后我们使用Theos的语法分析来把Logos转换成普通代码\n  `$THEOS/bin/logos.pl Tweak.xm > abc.mm`\n  *注意abc应该有mm作为后缀名，用于告诉clang目标语言类型*\n\n* 使用clang编译转换后的普通代码，并将结果放到app包内\n    `clang -shared -undefined dynamic_lookup -o ./SayHi.app/Contents/MacOS/lib.dylib ./abc.mm`\n\n* 使用optool/insert_dylib往SayHi的MachO头部添加我们刚刚编译的lib.dylib\n    `optool install -c load -p @executable_path/lib.dylib -t ./SayHi.app/Contents/MacOS/SayHi`\n\n如果你的Mac app没有签名的话，此时应该已经达成我们的需求了。但是实践中我们肯定不是对自己导出的未签名Mac app下黑手。所以需要去掉这个签名或重签名。因为笔者没有钱买开发者账号，故不知道如何重签名。\n\n* 使用codesign去除签名\n  `codesign --remove-signature SayHi.app `\n\n此时我们的需求已经达成\n![大成功](http://ooph3gs8p.bkt.clouddn.com/屏幕快照 2018-02-10 23.14.23.png)\n但是codesign有一个bug，在删除代码签名之后没有修复MachO Header的偏移，会导致生成的MachO文件畸形。笔者曾经就遇见一个不到1m的小程序在移除签名后膨胀到2g大小。\n所以笔者建议使用开源社区的代替方案——[unsign](https://github.com/steakknife/unsign) \n\n## 后记\n笔者把上面的繁琐命令行操作整合为一个脚本，在这里也顺便分享出来\n\n```bash\n#!/usr/bin/env bash\n\n#将xm和文件app包放在同一个目录，运行本脚步进行注入\n\npath=`ls | grep *.app | head -1`\ntweak=`ls | grep *.xm | head -1`\ntemp='x11901'\nname=${path%.app}\n\n$THEOS/bin/logos.pl \"./${tweak}\" > \"./${temp}.mm\"\nclang -shared -undefined dynamic_lookup -o \"./${path}/Contents/MacOS/lib.dylib\" \"./${temp}.mm\"\noptool install -c load -p @executable_path/lib.dylib -t \"./${path}/Contents/MacOS/${name}\"\n\nrm -f ${temp}.mm\n\n# 使用unsign效果可能更好，codesign --remove-signature 在删除代码签名之后没有修复MachO Header的偏移，导致生成的MachO文件畸形\n# codesign --remove-signature ${name}\nif [ ! -e \"./${path}/Contents/MacOS/${name}.ori\" ]; then\n    unsign \"./${path}/Contents/MacOS/${name}\"\n    mv \"./${path}/Contents/MacOS/${name}\" \"./${path}/Contents/MacOS/${name}.ori\"\n    mv \"./${path}/Contents/MacOS/${name}.unsigned\" \"./${path}/Contents/MacOS/${name}\"\nfi\n\nopen \"./${path}/Contents/MacOS/${name}\"\n```\n---\n[下载Demo](https://github.com/0x11901/SayHi)\n"},{"title":"重温《EVA》TV版25、26集有感","url":"/2018/02/07/重温《EVA》TV版25、26集有感/","content":"\n![header](http://ooph3gs8p.bkt.clouddn.com//20171028000424_hOICiM_maxresdefault.jpeg \"头图\")\n\n\n\n《**新世纪福音战士**》，简称《**EVA**》是我非常喜爱的一部动漫。最近在闲暇之余重温了其TV版25、26话，比起年少时多了几分感慨，故记录下来，方便日后回味\n\n虽说是想写点什么，但是实际写的时候完全不知从何下笔，所以按照影片的时间顺序结合我个人的分析起笔吧。但是在继续这个话题之前，我提出两个假设，以下的观点讲建立在这两个假设之下：\n\n 1. TV版25、26话与剧场版《The End of Evangelion》（简称EoE）讲诉了同一个故事，只是表现形式不同，即TV版描述了EoE中真嗣等人在“人类补完计划”前后的心理活动\n\n     *注：本条假设基于24话下集预告中出现的分镜和解说与剧场版Air高度一致，证明剧场版剧本早已完成*\n\n     ![Air](http://ooph3gs8p.bkt.clouddn.com//20171028215724_EGLFHF_屏幕快照%202017-10-28%20下午9.55.56.png \"Air\")\n\n 2. 作者主要以真嗣的心理\n\n## 真嗣\n\n25话一开头就打出了 *存在理由、レゾンデートル* 一行白字，除了告诉观众我们已经没钱了之外，也揭示了本小结的主题——真嗣存在的理由？![*存在理由、レゾンデートル* ](http://ooph3gs8p.bkt.clouddn.com//20171028212819_J9iNDG_屏幕快照%202017-10-28%20下午9.28.10.png \"*存在理由、レゾンデートル* \")\n\n> 存在的理由，可以待在这里的理由，碇真嗣他的情况\n>\n> 少年期望的死亡\n>\n> 少年达成他的愿望\n>\n> 最后的使徒消灭了\n> 可是，碇真嗣很苦脑\n> 为什么杀掉\n> ……\n>\n\n结合以前的剧情，很容易知道真嗣认为自己是不应该继续存在于这个世界的，正如太宰治的“生而为人，我很抱歉“，此时的真嗣是消极厌世的，他认为渚薰才是应该活下来的，而不是自己（哪怕为此牺牲了全人类）。他也不能接受自己杀了渚薰，认为自己杀了人，所以没有资格再活下去。\n\n> 真嗣：因为没有其他方法啊\n> 为什么杀掉\n> 真嗣：因为他是使徒啊\n> 即使同为人类？\n> 真嗣：不对，是使徒，他是我们的敌人\n> 即使同为人类？\n> 即使同为人类？\n> 真嗣：不对，不对，不对啊\n> 丽：明明跟我同样是人类啊\n> 真嗣：不对，他是使徒啊\n> 丽：所以杀掉\n> 真嗣：没错，不那样的话我们会死掉，大家都会被杀掉\n> 丽：所以杀掉\n> 真嗣：我也不想那么做，可是没有办法啊\n\n这里可以看出真嗣内心已经接近崩溃，虽然找出了很多理由来辩解为什么自己应该存在，辩解自己为什么应该杀死渚薰，但是反复出现的“所以杀掉”暗示了真嗣内心是不接受自己的辩解的，于是他选择了向他人求助，告诉他杀死渚薰、自己活下来的理由\n\n![help](http://ooph3gs8p.bkt.clouddn.com//20171028230517_0XSs9x_屏幕快照%202017-10-28%20下午10.56.14.png \"help\")\n\n然后画面闪回了24话末真嗣与美里在夜晚的湖边交谈\n\n> 真嗣：没错，活下来的应该是薰才对，他比我这种人不知道好多少倍，应该是薰活下来才对\n> 美里：不对，能活下来的只有怀抱生存意志的人，放弃生存的意思，把一切寄托在徒具表像的希望上，真嗣你没有错\n\n但是基于第一个假设，我认为25话应发生在交谈之后，所以此处除了省钱之外，应该算作回忆，美里的解释并不是真嗣想要的答案，不过我认为这是作者想要呈现给观众的答案\n\n​\t*顺便说一下，这时的真嗣去医院寻找了明日香的帮助，但是并没有得到帮助，而是……对于这样下流的主角，我只能说放开那个女孩，这种罪孽让我来承受*\n\n![OGC](http://ooph3gs8p.bkt.clouddn.com//20171028232420_b9lRrz_屏幕快照%202017-10-28%20下午11.20.31.png \"OGC\")\n\n紧接着又是一连串字幕\n\n![](http://ooph3gs8p.bkt.clouddn.com//20171028231206_Vy6FdZ_屏幕快照%202017-10-28%20下午11.11.29.png)\n\n大概这就是真嗣现在的想法，他认为自己正在被灌输正义，实际上无论何种解释，自己都没有理由在存活于世，不如死去。\n\n![](http://ooph3gs8p.bkt.clouddn.com//20171028232833_0LxvnT_屏幕快照%202017-10-28%20下午11.28.22.png)\n\n> 不安\n> 真嗣：这样真的好吗？\n> 强迫观念\n> 真嗣：我不知道，我该怎么办才好，该怎么办才好啊？\n> 在害怕什么？\n> 真嗣：害怕什么\n>\n> 在害怕什么？\n> 真嗣：自已\n> 在害怕什么？\n> 真嗣：怕被讨厌\n> 在害怕什么\n> 真嗣：被谁\n> 在害怕什么\n> 真嗣：谁呢？\n> 在害怕什么\n> 真嗣：那是…爸爸。我被爸爸拋弃，被爸爸讨厌\n> 真嗣：被讨厌的话该怎么办，怎么办才好\n\n接下来的这一段内心独白，说明了真嗣害怕被碇源渡讨厌，一个简单而又单纯的理由，折射的却是一个自幼被抛弃、残缺而破碎的内心。虽说每个人的一生难免都会被父母所伤害，但是真嗣的个人经历正是造成他性格的重要原因。对于一个14岁的少年，一次又一次的被父亲逼着“杀人”，正常情况下谁都会崩溃，真嗣的内心一遍遍的追问自己为什么害怕，而他的自卑、罪恶感也一步步把自己推向崩溃的边缘\n\n随着镜头一转，来到一片白雾中\n\n![白雾](http://ooph3gs8p.bkt.clouddn.com//20171029230516_lPSu6W_白雾.png \"迷蒙\")\n\n象征了此时的真嗣已经迷失自我\n\n> 真嗣：这是那里，我该去那里才好，什么都看不见，什么都不知道\n>\n> 美里小姐，那个，你到那里去了\n>\n> 那个，接下来我该去那里\n>\n> 美里小姐，明日香，丽，冬二，剑介，加持先生，律子小姐，爸爸…妈妈…谁来告诉我，告诉我到底该怎么办才好\n\n迷蒙中真嗣渴望得到别人的帮助，但是这是无济于事的。依据第二个假设，真嗣内心中出现的他人只是自己根据记忆构建的他人形象，虽然说出来的台词很像他人真正所说的，不过毕竟是自己所构建的。自己永远不可能欺骗自己，除非自己放弃了\n\n此时画面中出现了初号机，并一把抓住了真嗣\n\n![省钱镜头的致敬](http://ooph3gs8p.bkt.clouddn.com//20171029231323_p7Kmuw_省钱.png \"省钱镜头的致敬\")\n\n> EVA初号机，结果，我只能驾驶它吗？甚至还要杀掉喜欢的人，照爸爸还有大家说的，再次驾驶著它去战斗吗？妈妈，说说话吧　回答我啊\n\n此时突然出现的初号机，我认为有两层含义，一个是根据《EoE》的剧情，真嗣在美里留下“大人的吻”之后来到了初号机面前，但是他并没有坐上驾驶室，这里也许说明了他为什么不愿意再驾驶EVA，任凭我香如何呼喊\n\n![](http://ooph3gs8p.bkt.clouddn.com//20171029233159_czQ3SH_2017-10-2911.30.38s.png)\n\n第二层意思我认为是紧接上面，害怕被父亲讨厌的真嗣为了讨好父亲，成为大家眼中的乖孩子，不自愿地驾驶EVA，驾驶EVA是他为了博得父亲好感的一个也是唯一一个途径，哪怕一次次被伤害，一次次逃走，最终他都会回来驾驶EVA。而这一次EVA又来到了他的眼前，说明了他内心的绝望与矛盾……人生也何尝不是如此\n\n> 为什么驾驶EVA\n> 真嗣：因为大家要我驾驶\n> 所以就驾驶EVA?\n> 真嗣：那是为了大家啊，有什么不对\n> 你是为了大家，为了他人驾驶EVA吗？\n> 真嗣：没错啊，这不是件好事吗？不是一件非常好的事情吗？这样大家就会称赞我，就会重视我\n>\n> 明日香：骗人，你是白痴吗？结果还不是为了自己，你总是这样动不动就为自己辩解\n> 真嗣：是吗\n> 明日香：为了他人而努力这种想法，本身就是一种轻松的生活方式\n> 真嗣：是这样吗？\n>\n> 明日香：简言之，真嗣你很寂寞\n> 真嗣：是吗\n>\n> 明日香：你这样不过是一种依赖罢了\n> 真嗣：或许真是这样吧\n> 明日香：你只是一昧盼著自己被人需要不是吗\n> 真嗣：也许是吧\n\n纵观整部作品，真嗣大部分时间都不是自愿驾驶EVA的，有时为了帮助他人有时是为了自己。正如明日香所说，真嗣选择了一个轻松的活法——通过取得别人的认同而实现自己的人生价值。根据弗洛伊德精神分析学的基本原则\n\n> 包括遗传的性格构造在内，人心理的发展是由幼时的经历决定的\n\n造成目前真嗣这一性格很有可能是因为真嗣的童年经历。为了自己不再被抛弃，真嗣拼命寻找一个存在于此的理由——驾驶EVA，但是当他已经无法再驾驶EVA的时候，既是自己再次成为无用之物的时候（潜意识中真嗣认为自己将会再次被抛弃）\n\n虽说我们都知道事实并不如此，但是这也是局外人的观点，此时此刻真嗣是既不愿意再驾驶EVA，又不得不驾驶EVA，也许这也能解释真嗣为何在此时选择轻生。\n\n顺便提一下这里明日香的观点十分有趣，让我想到了正义的伙伴——卫宫士郎\n\n![正义的伙伴](http://ooph3gs8p.bkt.clouddn.com//20171031182843_vlUz6J_f_17148b5d2f7d52732cb5e7c96925f8e81.jpeg \"正义的伙伴\")\n\n也许是奈须蘑菇受到了痞子的启发，卫宫士郎的理想就被人评价为“偷来的理想”，而在这里真嗣被明日香说成了是寂寞\n\n> 寂寞是想要别人理解你\n>\n> 孤独是没有人能理解你\n\n可谓是一针见血，真嗣渴望被关注，渴望被爱，也曾经努力过，试图改变过，不过最后他认为自己失败了\n\n> 明日香：你只是一种等待別人给你幸福不是吗？给你虚假的幸福？\n> 丽：这方面你不也一样吗？\n> 明日香：啊？\n\n这时话锋一转，突然出现的绫波丽把矛头指向了明日香画面切到了水中的二号机（正好能和剧场版中昏迷的明日香同二号机一起沉入湖底避难）\n\n## 明日香与绫波丽\n\n> 明日香：不知不觉我又坐上了EVA，又被放了上来，反正这个废物也不会动了，不…废物应该是我吧，没人需要我这种人了，我这种人已经没人要了，没有人需要无法驾驶EVA的驾驶员\n> 丽：你在別人心中追寻自己呢\n>\n> 明日香：少啰嗦\n> 害怕分离\n> 丽：你害怕独自一人对吧？\n>\n> 改变话题，场景\n>\n> 害怕分离\n> 丽：你是因为自己也会和別人一起消失才害怕的吧？\n>\n> 害怕分离\n> 幼年的明日香：所以才驾驶EVA\n\n 明日香在剧中一贯给人开朗活泼的感觉，但是随着剧情的发展，明日香的精神状态急转直下。无法驾驶EVA的明日香离家出走并割腕自杀，说起来真的和真嗣很像。不过真嗣应属于被动型人格，明日香则正好相反，但是本质上他们都因为童年的阴影\n\n> 明日香：少啰嗦\n> 固执\n> 明日香：少啰嗦、少啰嗦，我才不想被妳这种人偶说教\n\n\n\n\n\n---\n\n\n\n\n"}]